# 安全遠端 PTZ 攝影機控制系統 (Secure Remote PTZ Control System)

## 專案概述
本系統允許您透過安全的 Firebase 中繼，遠端控制 Local 端的 Panasonic PTZ 攝影機。
- **本地客戶端 (Windows Exe):** 運行於與攝影機同一網路的 PC 上，負責接收指令並控制攝影機。
- **遠端網頁 (Web App):** 託管於 Firebase Hosting，供使用者透過手機或電腦遠端操作。

## 1. 設定與安裝

### 前置需求
- 開發電腦需安裝 **Node.js**。
- 需安裝 Firebase CLI 工具 (`npm install -g firebase-tools`)。

### 安裝依賴套件
請在專案根目錄 (即 `d:\ptzcntrl`) 執行以下指令：
```bash
npm install
```

## 2. 部署遠端網頁 (Remote Web App)
將遠端控制介面發布到網路上：

1. 登入 Firebase (若尚未登入):
   ```bash
   firebase login
   ```
2. 部署 Hosting 與安全性規則:
   ```bash
   firebase deploy
   ```
   *此指令會上傳 `hosting/public` 資料夾並套用 `firebase/database.rules.json` 安全規則。*

部署完成後，您的網頁網址將會是：`https://ptzcntrl.web.app`

## 3. 打包 Windows 客戶端 (Exe)
若要產生可獨立執行的 `.exe` 檔案：

```bash
npm run dist
```
打包完成後的 `.exe` 檔案將位於 `dist/` 資料夾中。

## 4. 使用說明

### 步驟 A: 本地端 PC (Client)
1. 執行打包好的 `.exe` 檔案 (或在開發模式下執行 `npm start`)。
2. 系統會顯示一個 Dashboard 小視窗。點擊 **"Open Settings (Web)"** 按鈕。
3. 瀏覽器會自動開啟設定頁面 (`localhost:5000`)。
4. 輸入自訂的 **房間號碼 (Room ID)** (例如 `OFFICE-01`) 與 **安全密碼 (Secret Password)**。
5. 點擊 **Start Server**。Dashboard 應顯示 "Connected" (已連線)。
6. 您現在可以點擊 **"Hide to Tray"** 將程式縮小至右下角系統列，讓它在背景執行。

### 步驟 B: 遠端使用者 (Remote User)
1. 開啟遠端網頁 (`https://ptzcntrl.web.app`)。
2. 輸入與本地端完全相同的 **房間號碼** 與 **密碼**。
3. 成功登入後，您將看到控制介面。選擇攝影機並使用方向鍵進行控制。

## 5. 手機操作介面說明

### 主畫面
- **搖桿區域**: 拖曳中央圓形搖桿以控制攝影機 Pan/Tilt
- **Zoom 按鈕**: 點擊 `+` 放大 / `-` 縮小
- **速度滑桿**: 調整移動速度 (1-100%)
- **預設點**: 點擊數字卡片呼叫預設位置

### 功能按鈕
- **☰ 選單**: 開啟攝影機選擇抽屜 (可切換單台或全控)
- **🔒 鎖定**: 開啟後防止誤觸

### 注意事項
- 建議使用 **橫向模式** 操作
- 登入後會自動進入全螢幕模式

## 6. 系統架構

```
┌─────────────────────────────────────────────┐
│         遠端使用者 (手機/電腦)              │
│     https://ptzcntrl.web.app                │
└──────────────────────┬──────────────────────┘
                       │ Firebase RTDB
                       ▼
┌──────────────────────────────────────────────┐
│              Firebase Cloud                  │
│  ┌────────────────┐  ┌────────────────────┐ │
│  │  Realtime DB   │  │   Hosting (Web)    │ │
│  │  (Commands)    │  │   (Control UI)     │ │
│  └────────────────┘  └────────────────────┘ │
└──────────────────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────┐
│     本地端 PC (Local Client)                 │
│     secure-ptz-control.exe                  │
│  ┌────────────────┐  ┌────────────────────┐ │
│  │  Express GUI   │  │  Firebase Admin    │ │
│  │  :5000         │  │  (Listener)        │ │
│  └────────────────┘  └────────────────────┘ │
│           │                  │              │
│           ▼                  ▼              │
│  ┌────────────────────────────────────────┐ │
│  │       PTZ Command Executor             │ │
│  │   (HTTP CGI to Panasonic Cameras)      │ │
│  └────────────────────────────────────────┘ │
└──────────────────────────────────────────────┘
                       │
                       ▼
         ┌─────────────────────────┐
         │   Panasonic PTZ Cameras │
         │   (區域網路內)           │
         └─────────────────────────┘
```

## 7. 故障排除 (Troubleshooting)

| 問題 | 解決方案 |
|------|----------|
| 無法連線至房間 | 確認 Room ID 與密碼完全一致 |
| 攝影機不動 | 檢查本地端是否已逾時斷線 (Watchdog) |
| 手機無法操作搖桿 | 嘗試旋轉為橫向模式 |
| 登入後空白 | 檢查 Firebase 連線狀態 (右上角綠點) |
| Dashboard 無法啟動 | 確認 `serviceAccountKey.json` 已正確放置於 `server/` 資料夾 |

## 8. 檔案結構

```
ptzcntrl/
├── server/                 # Electron 客戶端原始碼
│   ├── main.js             # 主程序 (Electron + Express)
│   ├── ptz.js              # PTZ 指令發送邏輯
│   ├── discovery.js        # 自動探索攝影機
│   ├── security.js         # 密碼驗證 & 指令過濾
│   ├── public/index.html   # 本地設定網頁
│   └── serviceAccountKey.json  # Firebase 服務帳戶金鑰 (需自行取得)
├── hosting/                # Firebase Hosting 網頁
│   └── public/index.html   # 遠端控制介面
├── firebase/               # Firebase 設定
│   └── database.rules.json # 資料庫安全規則
├── dist/                   # 打包輸出
│   └── win-unpacked/       # 可執行檔目錄
│       └── secure-ptz-control.exe
└── package.json            # 專案設定
```

## 9. 安全性機制

- **零知識密碼**: 密碼不儲存於雲端，僅於本地端驗證
- **指令白名單**: 僅允許 PTZ 相關指令，過濾惡意輸入
- **Watchdog**: 遠端斷線超過 5 秒，攝影機自動停止
- **Session 管理**: 斷線時自動清除使用者 Session

---
*Generated by Antigravity AI Agent*
