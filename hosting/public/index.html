<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PTZcntrl Remote</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- Nipple.js for Joystick -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
    <style>
        /* Global Reset for Mobile App Feel */
        * {
            box-sizing: border-box;
            -webkit-user-select: none;
            /* Chrome/Safari */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* IE10+ */
            user-select: none;
            /* Standard */
            -webkit-touch-callout: none;
            /* iOS Safari */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #000;
            color: #fff;
            margin: 0;
            /* Fix iOS Safari 100vh bug */
            height: 100vh;
            height: 100dvh;
            /* Dynamic viewport height */
            height: -webkit-fill-available;
            width: 100vw;
            overflow: hidden;
            /* Strict no-scroll */
            touch-action: none;
            /* Disable browser zooming/panning globally */
            display: flex;
            flex-direction: column;
        }

        html {
            height: -webkit-fill-available;
        }

        /* Portrait Warning Overlay */
        #portrait-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        /* Only show portrait warning when app is active (logged in) */
        @media (orientation: portrait) {
            body.app-active #portrait-warning {
                display: flex;
            }
        }

        /* Login Screen */
        #login-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            width: 80%;
            max-width: 300px;
            text-align: center;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 20px;
            background: #111;
        }

        .login-logo {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
        }

        /* Download Section */
        .download-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px dashed #444;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.03);
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        .download-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #888;
        }

        .download-section p {
            font-size: 12px;
            color: #666;
            margin: 0 0 15px 0;
            line-height: 1.5;
        }

        .download-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #0088ff;
            color: #fff;
            text-decoration: none;
            border-radius: 20px;
            font-size: 14px;
            transition: 0.2s;
        }

        .download-btn:hover {
            background: #0066cc;
        }

        input {
            -webkit-user-select: text;
            user-select: text;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #222;
            border: 1px solid #444;
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
        }

        .btn:active {
            background: #555;
        }

        /* App Layout */
        #app-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        /* HEADER */
        header {
            height: 60px;
            background: #111;
            border-bottom: 1px solid #222;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .menu-btn {
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        .cam-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            border-bottom: 1px dashed #444;
            padding-bottom: 2px;
            margin: 0 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #333;
        }

        .status-dot.online {
            background: #00ff00;
            box-shadow: 0 0 5px #00ff00;
        }

        /* MAIN CONTROLS (Joystick & Zoom) */
        .main-controls {
            flex: 1;
            display: flex;
            position: relative;
            background: #050505;
            overflow: hidden;
            /* Prevent spill */
        }

        .joystick-area {
            flex: 2;
            position: relative;
            border-right: 1px solid #222;
            touch-action: none;
            background: #050505;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* The visual container for the joystick */
        .joystick-scope {
            /* Responsive Size: Fits smaller of width/height */
            width: 50vmin;
            height: 50vmin;
            max-width: 240px;
            max-height: 240px;
            border-radius: 50%;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
            border: 1px solid #333;
            box-shadow: inset 0 0 20px #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
            /* Don't squash */
        }

        /* Inner decorative circle */
        .joystick-scope::after {
            content: '';
            position: absolute;
            width: 50%;
            height: 50%;
            border: 1px dashed #333;
            border-radius: 50%;
            pointer-events: none;
        }

        .joystick-helper-text {
            color: #555;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            pointer-events: none;
        }

        .zoom-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            background: #080808;
            border-left: 1px solid #222;
        }

        .zoom-row {
            display: flex;
            gap: 20px;
        }

        .zoom-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #222;
            border: 1px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            color: #ccc;
            cursor: pointer;
            transition: 0.1s;
        }

        .zoom-btn:active {
            background: #444;
            transform: scale(0.95);
            color: #fff;
        }

        /* Speed Slider */
        .speed-view {
            width: 80%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .speed-label {
            font-size: 12px;
            color: #888;
        }

        input[type=range] {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #0088ff;
            cursor: pointer;
            margin-top: -8px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }

        /* PRESETS GRID */
        .presets-area {
            height: 180px;
            background: #111;
            border-top: 1px solid #222;
            overflow-y: auto;
            padding: 10px;
            flex-shrink: 0;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .preset-card {
            background: #222;
            border: 1px solid #333;
            border-radius: 10px;
            height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
        }

        .preset-card.set {
            border-color: #0088ff;
            background: #0b1e33;
            color: #0088ff;
        }

        .preset-card.active {
            background: #0088ff;
            color: #fff;
        }

        .p-num {
            font-size: 18px;
            font-weight: bold;
        }

        .p-actions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            z-index: 10;
        }

        .preset-card.long-press .p-actions {
            display: flex;
        }

        .action-btn {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 15px;
            border: none;
            color: white;
            width: 60px;
        }

        .btn-set {
            background: #0088ff;
        }

        .btn-del {
            background: #ff4444;
        }

        /* Overlay/Modal */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 150;
            display: none;
        }

        .drawer {
            position: absolute;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background: #1a1a1a;
            padding: 20px;
            box-sizing: border-box;
            transform: translateX(-100%);
            transition: 0.3s;
        }

        .drawer.open {
            transform: translateX(0);
        }

        .cam-item {
            padding: 15px;
            border-bottom: 1px solid #333;
            color: #ccc;
            cursor: pointer;
        }

        .cam-item.active {
            color: #0088ff;
            font-weight: bold;
        }

        /* Lock Button */
        .lock-btn {
            position: fixed;
            /* Fixed to viewport */
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #edaf20;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: #edaf20;
            z-index: 1000;
            /* High z-index */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            cursor: pointer;
        }

        .lock-btn.locked {
            background: #edaf20;
            color: #000;
            border-color: #edaf20;
            box-shadow: 0 0 15px #edaf20;
        }

        /* Lock Blockers */
        #input-blocker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            display: none;
            background: rgba(0, 0, 0, 0);
        }

        /* PRESET ACTIONS */
        .preset-actions-row {
            display: flex;
            gap: 15px;
            padding: 10px;
            background: #111;
            border-top: 1px solid #222;
            flex-shrink: 0;
        }

        .p-action-btn {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
        }

        .btn-set-global {
            background: #0088ff;
        }

        .btn-set-global:active {
            background: #0066cc;
        }

        .btn-set-global:disabled {
            background: #222;
            color: #555;
            cursor: not-allowed;
        }

        .btn-del-global {
            background: #ff4444;
        }

        .btn-del-global:active {
            background: #cc0000;
        }

        .btn-del-global:disabled {
            background: #222;
            color: #555;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

    <!-- Portrait Warning -->
    <div id="portrait-warning">
        <div style="font-size: 40px; margin-bottom: 20px;">‚ü≥</div>
        <h2>Ë´ãÊóãËΩâËû¢Âπï</h2>
        <p>Ê≠§ÊáâÁî®Á®ãÂºèÂÉÖÊîØÊè¥Ê©´ÂêëÊ®°Âºè<br>Please rotate your device</p>
    </div>

    <!-- Login -->
    <div id="login-screen">
        <div class="login-box">
            <img src="icon_w.png" class="login-logo" alt="PTZ Control Logo">
            <input type="text" id="roomId" placeholder="Room ID">
            <input type="text" id="username" placeholder="Your Name">
            <input type="password" id="password" placeholder="Password">
            <button class="btn" onclick="attemptLogin()" id="loginBtn">Connect</button>
            <p id="login-msg" style="color: #ff5252; margin-top: 15px; display: none; font-size: 14px;"></p>
        </div>

        <!-- Server Download Section -->
        <div class="download-section">
            <h3>Server Download</h3>
            <p>Ëã•Ë¶ÅÊû∂Ë®≠Êú¨Âú∞ÊéßÂà∂‰º∫ÊúçÂô®Ôºå<br>Ë´ã‰∏ãËºâ Windows ‰º∫ÊúçÂô®Á´ØÁ®ãÂºèÔºö</p>
            <a href="https://github.com/ziv09/ptzcntrl/releases/latest/download/PTZcntrl-Setup.exe" class="download-btn"
                target="_blank">‚¨á ‰∏ãËºâ (GitHub)</a>
        </div>
    </div>

    <!-- App -->
    <div id="app-screen">
        <header>
            <div class="menu-btn" onclick="toggleDrawer()">‚ò∞</div>
            <div id="cam-title" class="cam-title" onclick="renameCamera()">Ë£ùÁΩÆÂ∞öÊú™ÈÄ£Á∑ö</div>
            <div id="status-dot" class="status-dot"></div>
        </header>

        <div class="main-controls">
            <div class="joystick-area">
                <div id="joystick-scope" class="joystick-scope"></div>
                <div class="joystick-helper-text">ÊãñÊõ≥‰ªª‰∏ÄÊñπÂêëÂç≥ÂèØÁßªÂãïÈè°È†≠</div>
            </div>
            <div class="zoom-area">
                <div class="zoom-row">
                    <div class="zoom-btn" id="btn-zoom-in" oncontextmenu="return false;">+</div>
                    <div class="zoom-btn" id="btn-zoom-out" oncontextmenu="return false;">-</div>
                </div>
                <div class="speed-view">
                    <span class="speed-label" id="speed-label">Speed: 50%</span>
                    <input type="range" id="speed-slider" min="1" max="100" value="50"
                        oninput="updateSpeed(this.value)">
                </div>
            </div>
        </div>

        <div class="presets-area">
            <div id="preset-grid" class="preset-grid">
                <!-- 10 Presets generated by JS -->
            </div>
        </div>

        <!-- Global Preset Actions -->
        <div class="preset-actions-row">
            <button id="btn-set-global" class="p-action-btn btn-set-global" onclick="onSetClick()" disabled>Ë®≠ÂÆö
                (Set)</button>
            <button id="btn-del-global" class="p-action-btn btn-del-global" onclick="onDelClick()" disabled>Âà™Èô§
                (Del)</button>
        </div>

        <!-- Float Lock -->
        <div class="lock-btn" id="lock-btn" onclick="toggleLock()">üîí</div>

        <!-- Drawer -->
        <div id="drawer-overlay" class="modal-overlay" onclick="toggleDrawer()">
            <div id="cam-drawer" class="drawer" onclick="event.stopPropagation()">
                <h3 style="border-bottom:1px solid #444; padding-bottom:10px; margin-top:0;">Cameras</h3>
                <div id="cam-list"></div>
                <div class="cam-item" onclick="location.reload()"
                    style="color: #ff4444; border-top: 1px solid #333; margin-top: 20px;">
                    ÁôªÂá∫ (Logout)
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DEBUG: Catch Mobile Errors ---
        window.onerror = function (msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            return false;
        };

        // CONFIG
        const firebaseConfig = {
            databaseURL: "https://ptzcntrl-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentRoom = null;
        let pword = null;
        let username = null;
        let clientId = 'web_' + Math.random().toString(36).substr(2, 9);
        let currentCamId = 'ALL';
        let currentCamName = 'Â∞öÊú™ÈÄ£Á∑ö';
        let moveSpeed = 50;
        let serverIp = null;
        let joystickManager = null;
        let zoomInterval = null;
        let isLocked = false;

        // Prevent Default Scrolling GLOBALLY
        // Fix for "Layout Exploded" -> if layout breaks, browser might scroll. 
        // We force block it.
        document.body.addEventListener('touchmove', function (e) {
            // Exceptions for scrollable areas
            if (e.target.closest('.presets-area') || e.target.closest('.drawer') || e.target.closest('.console-body') || e.target.tagName === 'INPUT') {
                return; // Let it bubble/scroll naturally
            }

            // Block everything else to prevent "Exploeded" layout scrolling
            if (e.cancelable) e.preventDefault();
        }, { passive: false });

        // --- LOGIN LOGIC ---
        function attemptLogin() {
            const r = document.getElementById('roomId').value.trim();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;

            if (!r || !p || !u) return alert("Please fill all fields");

            document.getElementById('loginBtn').innerText = "Connecting...";
            document.getElementById('loginBtn').disabled = true;

            const reqRef = db.ref(`rooms/${r}/request_login/${clientId}`);
            const sessionRef = db.ref(`rooms/${r}/sessions/${clientId}`);

            reqRef.set({ password: p, username: u, timestamp: firebase.database.ServerValue.TIMESTAMP });

            let responded = false;
            setTimeout(() => {
                if (!responded) {
                    alert("Timeout: No response from server.");
                    window.location.reload();
                }
            }, 5000);

            sessionRef.on('value', (snap) => {
                const val = snap.val();
                if (val) {
                    responded = true;
                    if (val.authorized) {
                        currentRoom = r; pword = p; username = u;
                        enterApp();
                    } else {
                        alert("Access Denied");
                        window.location.reload();
                    }
                }
            });
        }

        function enterApp() {
            document.body.classList.add('app-active'); // Enable Portrait Warning

            // Try Fullscreen
            try {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
                    document.documentElement.webkitRequestFullscreen();
                }
            } catch (e) { console.log("Fullscreen blocked"); }

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';

            // Connection Monitor
            db.ref('.info/connected').on('value', snap => {
                document.getElementById('status-dot').className = snap.val() ? "status-dot online" : "status-dot";
            });

            // Room Closure Monitor
            db.ref(`rooms/${currentRoom}`).on('value', snap => {
                if (!snap.exists()) {
                    alert("Room Closed by Host");
                    window.location.reload();
                }
            });

            // Listen for Server IP to filter
            db.ref(`rooms/${currentRoom}/status/ip`).once('value', snap => {
                serverIp = snap.val();
                loadCameras(); // Reload cams if IP eventually arrives
            });

            // Clean up on disconnect
            db.ref(`rooms/${currentRoom}/sessions/${clientId}`).onDisconnect().remove();

            initJoystick();
            initZoom();
            loadCameras();
            renderPresets();

            // Force Layout Update
            window.dispatchEvent(new Event('resize'));
        }

        // --- JOYSTICK ---
        function initJoystick() {
            const zone = document.getElementById('joystick-scope');
            if (joystickManager) joystickManager.destroy();

            // Calculate size based on actual scope size
            const rect = zone.getBoundingClientRect();
            const size = Math.min(rect.width, rect.height) * 0.5; // 50% of container

            joystickManager = nipplejs.create({
                zone: zone,
                mode: 'static',
                position: { left: '50%', top: '50%' },
                color: '#0088ff',
                size: size,
                restOpacity: 0.8,
                catchDistance: 200
            });

            joystickManager.on('move', (evt, data) => {
                if (isLocked) return;

                try {
                    // Vector Logic - Robust Extraction
                    let vector = data.vector;

                    // Fallback if vector is missing
                    if (!vector && data.angle) {
                        const rad = data.angle.radian;
                        vector = {
                            x: Math.cos(rad),
                            y: Math.sin(rad) // NippleJS Up is -Y? Let's check. Usually screen coords.
                            // Actually, standard math is +Y up. Screen is +Y down.
                            // If user said "Chaotic", maybe inverted?
                            // Let's standard math for now.
                        };
                        // Invert Y for screen coords if needed. NippleJS 'up' usually has -Y.
                        // But let's assume raw math first.
                        // Wait, NippleJS data.vector is usually { x, y } normalized.
                    }

                    if (!vector || (typeof vector.x !== 'number')) return;

                    const force = Math.min(data.force, 2.0);
                    const speedVal = parseInt(force * moveSpeed);

                    throttleCommand('PTZ_VECTOR', {
                        vector: { x: vector.x, y: vector.y },
                        speed: speedVal
                    });
                } catch (err) {
                    console.error("Joystick Error", err);
                }
            });

            // Enhanced Failsafe: Global Listener
            // When nipple starts, add global up listener
            const globalStop = () => sendCommand('STOP');

            joystickManager.on('start', () => {
                window.addEventListener('touchend', globalStop);
                window.addEventListener('mouseup', globalStop);
            });

            joystickManager.on('end', () => {
                window.removeEventListener('touchend', globalStop);
                window.removeEventListener('mouseup', globalStop);
                sendCommand('STOP');
            });

            // Keep local failsafe just in case
            zone.addEventListener('touchend', globalStop);
            zone.addEventListener('mouseup', globalStop);
        }

        let lastCmdTime = 0;
        function throttleCommand(action, speed) {
            const now = Date.now();
            if (now - lastCmdTime > 200) {
                sendCommand(action, speed);
                lastCmdTime = now;
            }
        }

        // --- ZOOM (Long Press) ---
        function initZoom() {
            const setupBtn = (id, action) => {
                const btn = document.getElementById(id);
                const start = (e) => {
                    if (isLocked) return;
                    e.preventDefault(); // Prevent ghost clicks

                    // Stop any existing intervals first
                    if (zoomInterval) clearInterval(zoomInterval);

                    // Send initial command
                    sendCommand(action);

                    // Start auto-repeat
                    zoomInterval = setInterval(() => sendCommand(action), 200);

                    // Add Global Listeners to catch release ANYWHERE
                    window.addEventListener('touchend', end);
                    window.addEventListener('mouseup', end);
                };

                const end = (e) => {
                    // Clean up global listeners
                    window.removeEventListener('touchend', end);
                    window.removeEventListener('mouseup', end);

                    if (zoomInterval) {
                        clearInterval(zoomInterval);
                        zoomInterval = null;
                        sendCommand('STOP'); // Enforce STOP
                    }
                };

                btn.addEventListener('touchstart', start);
                btn.addEventListener('mousedown', start);

                // Keep mouseleave just in case, but global mouseup handles most
                // btn.addEventListener('mouseleave', end);
            };

            setupBtn('btn-zoom-in', 'ZOOM_IN');
            setupBtn('btn-zoom-out', 'ZOOM_OUT');
        }

        // --- CAMERAS ---
        function loadCameras() {
            if (!currentRoom) return;
            db.ref(`rooms/${currentRoom}/devices`).on('value', snap => {
                const list = document.getElementById('cam-list');
                const title = document.getElementById('cam-title');
                list.innerHTML = '';

                const val = snap.val();
                let validCameras = [];

                if (val) {
                    Object.keys(val).forEach(key => {
                        const dev = val[key];
                        if (serverIp && dev.ip === serverIp) return; // Filter Server IP
                        // Default name is IP (without "IP: " prefix per user request)
                        validCameras.push({ id: key, name: dev.name || dev.ip });
                    });
                }

                if (validCameras.length === 0) {
                    title.innerText = "Ë£ùÁΩÆÂ∞öÊú™ÈÄ£Á∑ö";
                    currentCamId = null;
                    list.innerHTML = '<div class="cam-item">Ê≤íÊúâÂèØÁî®ÁöÑÊîùÂΩ±Ê©ü</div>';
                    return;
                }

                // Add All Cameras Option
                const allItem = document.createElement('div');
                allItem.className = `cam-item ${currentCamId === 'ALL' ? 'active' : ''}`;
                allItem.innerText = "All Cameras";
                allItem.onclick = () => selectCam('ALL', 'All Cameras');
                list.appendChild(allItem);

                validCameras.forEach(cam => {
                    const item = document.createElement('div');
                    item.className = `cam-item ${currentCamId === cam.id ? 'active' : ''}`;
                    item.innerText = cam.name;
                    item.onclick = () => selectCam(cam.id, cam.name);
                    list.appendChild(item);
                });

                // Set Title Logic
                if (currentCamId === 'ALL') {
                    title.innerText = "All Cameras";
                } else if (!validCameras.find(c => c.id === currentCamId)) {
                    // If current cam disappeared, switch to ALL or Empty
                    title.innerText = "All Cameras";
                    currentCamId = "ALL";
                } else {
                    title.innerText = currentCamName;
                }
            });
        }

        function selectCam(id, name) {
            currentCamId = id;
            currentCamName = name;
            document.getElementById('cam-title').innerText = name;
            toggleDrawer(); // Close menu
            renderPresets(); // Reload presets for this cam
        }

        function renameCamera() {
            if (!currentCamId || currentCamId === 'ALL') return alert("ÁÑ°Ê≥ïÈáçÊñ∞ÂëΩÂêç 'All Cameras'");
            const newName = prompt("Ëº∏ÂÖ•Êñ∞ÁöÑÊîùÂΩ±Ê©üÂêçÁ®± (Enter new name):", currentCamName);
            if (newName && newName !== currentCamName) {
                // Send RENAME command to Server so it updates local state & syncs back
                db.ref(`rooms/${currentRoom}/commands`).push({
                    action: 'RENAME',
                    target: currentCamId,
                    name: newName,
                    password: pword,
                    username: username,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function toggleDrawer() {
            const d = document.getElementById('cam-drawer');
            const o = document.getElementById('drawer-overlay');
            if (d.classList.contains('open')) {
                d.classList.remove('open');
                setTimeout(() => o.style.display = 'none', 300);
            } else {
                o.style.display = 'block';
                // force reflow
                void d.offsetWidth;
                d.classList.add('open');
            }
        }

        // --- PRESETS ---
        function renderPresets() {
            const grid = document.getElementById('preset-grid');
            grid.innerHTML = '';
            selectedPresetId = null;
            updateGlobalButtons();

            for (let i = 1; i <= 10; i++) {
                const card = document.createElement('div');
                card.className = 'preset-card';
                card.id = `preset-${i}`;
                card.innerHTML = `<div class="p-num">${i}</div>`;

                if (currentCamId && currentCamId !== 'ALL') {
                    db.ref(`rooms/${currentRoom}/devices/${currentCamId}/presets/${i}`).on('value', snap => {
                        if (snap.exists()) {
                            card.classList.add('set');
                        } else {
                            card.classList.remove('set');
                        }
                        // Re-check buttons if currently selected
                        if (selectedPresetId === i) updateGlobalButtons();
                    });
                }

                card.onclick = () => {
                    if (isLocked) return;
                    selectPresetSlot(i);
                };
                grid.appendChild(card);
            }
        }

        let selectedPresetId = null;

        function selectPresetSlot(id) {
            if (selectedPresetId) {
                document.getElementById(`preset-${selectedPresetId}`).classList.remove('active');
            }
            selectedPresetId = id;
            const card = document.getElementById(`preset-${id}`);
            card.classList.add('active');

            updateGlobalButtons();

            if (card.classList.contains('set')) {
                sendCommand('PRESET_CALL', id);
            }
        }

        function updateGlobalButtons() {
            const btnSet = document.getElementById('btn-set-global');
            const btnDel = document.getElementById('btn-del-global');

            if (selectedPresetId === null) {
                btnSet.disabled = true;
                btnDel.disabled = true;
                return;
            }

            btnSet.disabled = false;
            const card = document.getElementById(`preset-${selectedPresetId}`);
            if (card && card.classList.contains('set')) {
                btnDel.disabled = false;
            } else {
                btnDel.disabled = true;
            }
        }

        function onSetClick() {
            if (!selectedPresetId) return;
            const confirmMsg = `ÊòØÂê¶Ë®≠ÂÆöÈ†êË®≠Èªû ${selectedPresetId}Ôºü\n(Set Preset ${selectedPresetId}?)`;
            if (!confirm(confirmMsg)) return;

            sendCommand('PRESET_SET', selectedPresetId);

            // Optimistic update
            if (currentCamId && currentCamId !== 'ALL') {
                db.ref(`rooms/${currentRoom}/devices/${currentCamId}/presets/${selectedPresetId}`).set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function onDelClick() {
            if (!selectedPresetId) return;
            const confirmMsg = `ÊòØÂê¶Âà™Èô§È†êË®≠Èªû ${selectedPresetId}Ôºü\n(Delete Preset ${selectedPresetId}?)`;
            if (!confirm(confirmMsg)) return;

            if (currentCamId && currentCamId !== 'ALL') {
                db.ref(`rooms/${currentRoom}/devices/${currentCamId}/presets/${selectedPresetId}`).remove();
            }
        }

        // --- SCREEN LOCK ---
        // Just Visual now since we block scroll globally
        function toggleLock() {
            isLocked = !isLocked;
            const btn = document.getElementById('lock-btn');
            // const blocker = document.getElementById('input-blocker');
            if (isLocked) {
                btn.classList.add('locked');
                // blocker.style.display = 'block';
            } else {
                btn.classList.remove('locked');
                // blocker.style.display = 'none';
            }
        }

        // --- COMMANDS ---
        function updateSpeed(val) {
            moveSpeed = parseInt(val);
            document.getElementById('speed-label').innerText = `Speed: ${val}%`;
        }

        // --- COMMANDS ---
        function sendCommand(action, param = 50) {
            if (!currentRoom || !currentCamId) return;

            const targetDevice = currentCamId;

            // Handle overloaded param (int speed OR object payload)
            let speed = 50;
            let vector = null;

            if (typeof param === 'object') {
                speed = param.speed || 50;
                vector = param.vector || null;
            } else {
                speed = param;
            }

            const cmd = {
                action: action,
                target: targetDevice,
                speed: speed,
                vector: vector, // Add Vector Data
                username: username,
                password: pword,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Optimistic UI or just send
            // log("Sending " + action);

            // Push to shared commands queue
            db.ref(`rooms/${currentRoom}/commands`).push(cmd);
        }
    </script>
</body>

</html>